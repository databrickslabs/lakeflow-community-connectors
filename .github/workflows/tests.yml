name: Tests

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # Detect which paths changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      libs: ${{ steps.filter.outputs.libs }}
      pipeline: ${{ steps.filter.outputs.pipeline }}
      example: ${{ steps.filter.outputs.example }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            libs:
              - 'libs/**'
            pipeline:
              - 'pipeline/**'
            example:
              - 'sources/example/**'
              - 'sources/interface/**'

  # Test libs
  test-libs:
    needs: changes
    if: ${{ needs.changes.outputs.libs == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run libs tests
        run: |
          pytest libs/test/ -v

  # Test pipeline
  test-pipeline:
    needs: changes
    if: ${{ needs.changes.outputs.pipeline == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run pipeline tests
        run: |
          pytest pipeline/test/ -v

  # Test example source
  test-example:
    needs: changes
    if: ${{ needs.changes.outputs.example == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run example tests
        run: |
          pytest sources/example/test/ -v
